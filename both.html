<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Both • FalaaFreebies</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="topbar">
    <nav class="nav">
      <a class="brand" href="index.html">FalaaFreebies</a>
      <div class="nav-right">
        <a href="both.html">Home</a>
        <a href="both.html#add">Add Item</a>
        <a href="both.html#browse">Browse</a>
        <button id="logoutBtn" class="btn-ghost">Logout</button>
      </div>
    </nav>
  </header>

  <main class="container">
    <section class="card">
      <h1>Giver & Taker • Combined Dashboard</h1>
      <p class="muted">You can both post items and browse items.</p>

      <!-- Add Item -->
      <section id="add" class="card-section">
        <h2>Add New Item</h2>
        <form id="addItemForm" class="form">
          <input id="itemTitle" name="title" type="text" placeholder="Title" required />
          <select id="itemCategory" name="category" required>
            <option value="">Category</option>
            <option value="food">Food</option>
            <option value="clothes">Clothes</option>
            <option value="electronics">Electronics</option>
            <option value="other">Other</option>
          </select>
          <textarea id="itemDescription" name="description" rows="4" placeholder="Description"></textarea>
          <input id="itemPhoto" name="photo" type="file" accept="image/*" />
          <button type="submit">Post Item</button>
        </form>
      </section>

      <!-- Browse -->
      <section id="browse" class="card-section">
        <h2>Browse</h2>
        <div class="search-row">
          <input id="searchInput" type="search" placeholder="Search items or keywords" />
          <button id="searchBtn">Search</button>
        </div>
        <div id="categories" class="categories-grid" style="margin-top:12px;">
          <button class="category-btn" data-cat="food">Food</button>
          <button class="category-btn" data-cat="clothes">Clothes</button>
          <button class="category-btn" data-cat="electronics">Electronics</button>
          <button class="category-btn" data-cat="other">Other</button>
        </div>
        <div id="browseResults" class="items-grid" style="margin-top:12px;">
          <!-- browse.js renders results -->
        </div>
      </section>

      <!-- My Items -->
      <section class="card-section">
        <h2>My Items</h2>
        <div id="myItemsList" class="items-grid">
          <!-- giver.js renders user's items -->
        </div>
      </section>

      <!-- Chat -->
      <section class="card-section">
        <h2>Chat</h2>
        <div id="chatPanel">
          <!-- chat.js will mount here -->
        </div>
      </section>

      <div id="msg" class="muted"></div>
    </section>
  </main>

  <footer class="footer">© FalaaFreebies</footer>

  <!-- Firebase setup -->
  <script type="module" src="./firebase-init.js"></script>

  <!-- Core + page scripts -->
  <script type="module" src="./app.js"></script>
  <script type="module" src="./auth.js"></script>
  <script type="module" src="./protect.js"></script>

  <!-- Page logic -->
  <script type="module" src="./giver.js"></script>
  <script type="module" src="./browse.js"></script>
  <script type="module" src="./chat.js"></script>

  <!-- Immediate role protection: only 'both' allowed -->
  <script type="module">
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    (async function protectByRole(){
      if (!window.auth) return;
      const user = window.auth.currentUser;
      if (!user) return;
      try {
        const userDoc = await getDoc(doc(window.db, "users", user.uid));
        const role = userDoc.exists() ? userDoc.data().role : null;
        if (role !== "both") {
          alert("This page is for users with role 'both'. Redirecting...");
          if (role === "giver") window.location = "giver.html";
          else if (role === "taker") window.location = "taker.html";
          else window.location = "index.html";
        }
      } catch (err) {
        console.error("Role check failed:", err);
      }
    })();
  </script>
</body>
</html>
