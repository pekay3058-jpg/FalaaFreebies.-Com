<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Giver • FalaaFreebies</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="topbar">
    <nav class="nav">
      <a class="brand" href="index.html">FalaaFreebies</a>
      <div class="nav-right">
        <a href="giver.html">My Items</a>
        <a href="giver.html#add">Add Item</a>
        <a href="both.html">Browse</a>
        <button id="logoutBtn" class="btn-ghost">Logout</button>
      </div>
    </nav>
  </header>

  <main class="container">
    <section class="card">
      <h1>Giver Dashboard</h1>
      <p class="muted">Post items you want to give away and manage them here.</p>

      <!-- Add Item -->
      <section id="add" class="card-section">
        <h2>Add New Item</h2>
        <form id="addItemForm" class="form">
          <input id="itemTitle" name="title" type="text" placeholder="Item title" required />
          <select id="itemCategory" name="category" required>
            <option value="">Select category</option>
            <option value="food">Food</option>
            <option value="clothes">Clothes</option>
            <option value="electronics">Electronics</option>
            <option value="other">Other</option>
          </select>
          <textarea id="itemDescription" name="description" rows="4" placeholder="Description"></textarea>
          <input id="itemPhoto" name="photo" type="file" accept="image/*" />
          <button type="submit">Post Item</button>
        </form>
      </section>

      <!-- My Items -->
      <section class="card-section">
        <h2>My Items</h2>
        <div id="myItemsList" class="items-grid">
          <!-- js/giver.js should render cards here (edit/delete actions) -->
        </div>
      </section>

      <!-- Chat -->
      <section class="card-section">
        <h2>Chat</h2>
        <div id="chatPanel">
          <!-- js/chat.js will mount chat UI here -->
        </div>
      </section>

      <div id="msg" class="muted"></div>
    </section>
  </main>

  <footer class="footer">© FalaaFreebies</footer>

  <!-- Firebase setup (must initialize window.auth & window.db) -->
  <script type="module" src="js/firebase-init.js"></script>

  <!-- Core + page scripts -->
  <script type="module" src="js/app.js"></script>
  <script type="module" src="js/auth.js"></script>
  <script type="module" src="js/protect.js"></script>

  <!-- Page-specific -->
  <script type="module" src="js/giver.js"></script>
  <script type="module" src="js/chat.js"></script>

  <!-- Immediate role protection: only 'giver' or 'both' allowed -->
  <script type="module">
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    (async function protectByRole(){
      if (!window.auth) return; // init not ready — protect.js/onAuthStateChanged will also guard
      const user = window.auth.currentUser;
      if (!user) return; // not logged in — protect.js will redirect
      try {
        const userDoc = await getDoc(doc(window.db, "users", user.uid));
        const role = userDoc.exists() ? userDoc.data().role : null;
        if (role !== "giver" && role !== "both") {
          // Not permitted here
          alert("Access denied for your role. Redirecting to your dashboard...");
          if (role === "taker") window.location = "taker.html";
          else window.location = "index.html";
        }
      } catch (err) {
        console.error("Role check failed:", err);
      }
    })();

    // Logout button wired to auth.js signOut (auth.js already listens for #logoutBtn)
  </script>
</body>
</html>
